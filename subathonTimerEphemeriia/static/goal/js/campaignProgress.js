const giftSVG =
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><style>.cls-1{fill:var(--gift-color-1);}.cls-2{fill:var(--gift-color-2);}</style></defs><g id="Calque_4" data-name="Calque 4"><path class="cls-1" d="M518.29,572.09,480.68,572l.26-220.54c12.56-.12,25.1-.19,37.62-.1Z"/><path class="cls-1" d="M533.68,325.44c262.93-7.62,505.1-133.53,359.67-257.84-141-120.51-361,94.63-383.83,232.28C507.18,314.06,519.3,325.84,533.68,325.44Zm161-172.85a77.25,77.25,0,1,1,77.14,77.33A77.22,77.22,0,0,1,694.71,152.59ZM635,248.48a38.31,38.31,0,1,1,38.27,38.35A38.32,38.32,0,0,1,635,248.48Zm-75.81-22.73A28.21,28.21,0,1,1,587.39,254,28.2,28.2,0,0,1,559.23,225.75Z"/><path class="cls-2" d="M902.26,406.25l-.17,145.34a21,21,0,0,1-21,20.92l-325.21-.39.26-220.3a2296.43,2296.43,0,0,1,325.46,30C893.07,383.68,902.28,394.68,902.26,406.25Z"/><path class="cls-2" d="M841.51,613.43l-.39,334.1a21,21,0,0,1-21,20.93l-264.71-.32.45-376,264.7.29A21,21,0,0,1,841.51,613.43Z"/><polygon class="cls-1" points="517.84 968.09 480.22 968.05 480.67 592.06 518.29 592.1 517.84 968.09"/><path class="cls-1" d="M465.91,325.36c14.35.44,26.5-11.32,24.19-25.49C467.6,162.15,248.15-53.5,106.84,66.67-38.91,190.64,203,317.11,465.91,325.36ZM398.17,257.6a22.65,22.65,0,1,1,22.6,22.65A22.64,22.64,0,0,1,398.17,257.6Zm-97.51-37.7a41.51,41.51,0,1,1,41.46,41.57A41.53,41.53,0,0,1,300.66,219.9ZM140.4,152a77.26,77.26,0,1,1,77.16,77.32A77.24,77.24,0,0,1,140.4,152Z"/><path class="cls-2" d="M178.35,591.7l264.7.3-.45,376-264.7-.31a21,21,0,0,1-20.92-21l.4-334.12A21,21,0,0,1,178.35,591.7Z"/><path class="cls-2" d="M117.85,381.13a2607.66,2607.66,0,0,1,325.49-29L443.08,572l-325.21-.39a20.94,20.94,0,0,1-20.93-21l.18-145.34C97.12,393.72,106.41,382.87,117.85,381.13Z"/></g></svg>';
const giftValidateSVG =
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><style>.gift-1{fill:var(--gift-validate-color-1);}.gift-2{fill:var(--gift-validate-color-2);}</style></defs><g id="Calque_4" data-name="Calque 4"><path class="gift-1" d="M518.29,572.09,480.68,572l.26-220.54c12.56-.12,25.1-.19,37.62-.1Z"/><path class="gift-1" d="M533.68,325.44c262.93-7.62,505.1-133.53,359.67-257.84-141-120.51-361,94.63-383.83,232.28C507.18,314.06,519.3,325.84,533.68,325.44Zm161-172.85a77.25,77.25,0,1,1,77.14,77.33A77.22,77.22,0,0,1,694.71,152.59ZM635,248.48a38.31,38.31,0,1,1,38.27,38.35A38.32,38.32,0,0,1,635,248.48Zm-75.81-22.73A28.21,28.21,0,1,1,587.39,254,28.2,28.2,0,0,1,559.23,225.75Z"/><path class="gift-2" d="M902.26,406.25l-.17,145.34a21,21,0,0,1-21,20.92l-325.21-.39.26-220.3a2296.43,2296.43,0,0,1,325.46,30C893.07,383.68,902.28,394.68,902.26,406.25Z"/><path class="gift-2" d="M841.51,613.43l-.39,334.1a21,21,0,0,1-21,20.93l-264.71-.32.45-376,264.7.29A21,21,0,0,1,841.51,613.43Z"/><polygon class="gift-1" points="517.84 968.09 480.22 968.05 480.67 592.06 518.29 592.1 517.84 968.09"/><path class="gift-1" d="M465.91,325.36c14.35.44,26.5-11.32,24.19-25.49C467.6,162.15,248.15-53.5,106.84,66.67-38.91,190.64,203,317.11,465.91,325.36ZM398.17,257.6a22.65,22.65,0,1,1,22.6,22.65A22.64,22.64,0,0,1,398.17,257.6Zm-97.51-37.7a41.51,41.51,0,1,1,41.46,41.57A41.53,41.53,0,0,1,300.66,219.9ZM140.4,152a77.26,77.26,0,1,1,77.16,77.32A77.24,77.24,0,0,1,140.4,152Z"/><path class="gift-2" d="M178.35,591.7l264.7.3-.45,376-264.7-.31a21,21,0,0,1-20.92-21l.4-334.12A21,21,0,0,1,178.35,591.7Z"/><path class="gift-2" d="M117.85,381.13a2607.66,2607.66,0,0,1,325.49-29L443.08,572l-325.21-.39a20.94,20.94,0,0,1-20.93-21l.18-145.34C97.12,393.72,106.41,382.87,117.85,381.13Z"/></g></svg>';
const calendarSVG =
    '<svg id="Calque_2" data-name="Calque 2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1000 1000"> <defs> <style> .calendar-1, .calendar-5 { fill: none; } .calendar-2 { opacity: 0.6; } .calendar-3 { fill: var(--calendar-color-1); } .calendar-4 { fill: var(--calendar-color-2); } .calendar-5 { stroke: var(--calendar-color-2); stroke-miterlimit: 10; } .calendar-7 { fill: var(--calendar-color-1); } .calendar-11 { fill: var(--calendar-color-3); } </style> <clipPath id="clip-path"> <circle class="calendar-1" cx="729.75" cy="179.38" r="41.25" /> </clipPath> <clipPath id="clip-path-2"> <circle class="calendar-1" cx="564.75" cy="179.38" r="41.25" /> </clipPath> <clipPath id="clip-path-3"> <circle class="calendar-1" cx="399.75" cy="179.38" r="41.25" /> </clipPath> <clipPath id="clip-path-4"> <circle class="calendar-1" cx="232.87" cy="179.38" r="41.25" /> </clipPath> </defs> <g class="calendar-2"> <path class="calendar-3" d="M100.12,409.63H934.5a0,0,0,0,1,0,0V870.76A110.74,110.74,0,0,1,823.75,981.5H210.87A110.74,110.74,0,0,1,100.12,870.76V409.63a0,0,0,0,1,0,0Z" /> <path class="calendar-3" d="M209.66,141.5H825A109.54,109.54,0,0,1,934.5,251V409.63a0,0,0,0,1,0,0H100.12a0,0,0,0,1,0,0V251A109.54,109.54,0,0,1,209.66,141.5Z" /> </g> <path class="calendar-3" d="M64.12,370.63H898.5a0,0,0,0,1,0,0V831.76A110.74,110.74,0,0,1,787.75,942.5H174.87A110.74,110.74,0,0,1,64.12,831.76V370.63a0,0,0,0,1,0,0Z" /> <path class="calendar-4" d="M173.66,102.5H789A109.54,109.54,0,0,1,898.5,212V370.63a0,0,0,0,1,0,0H64.12a0,0,0,0,1,0,0V212A109.54,109.54,0,0,1,173.66,102.5Z" /> <circle class="calendar-5" cx="230.88" cy="179.38" r="41.25" /> <circle class="calendar-5" cx="397.75" cy="179.38" r="41.25" /> <circle class="calendar-5" cx="562.75" cy="179.38" r="41.25" /> <circle class="calendar-3" cx="729.75" cy="179.38" r="41.25" /> <g class="calendar-6"> <rect class="calendar-7" x="728.81" y="178.44" width="56.25" height="50.63" /> </g> <circle class="calendar-3" cx="564.75" cy="179.38" r="41.25" /> <g class="calendar-8"> <rect class="calendar-7" x="563.81" y="178.44" width="56.25" height="50.63" /> </g> <circle class="calendar-3" cx="399.75" cy="179.38" r="41.25" /> <g class="calendar-9"> <rect class="calendar-7" x="398.81" y="178.44" width="56.25" height="50.63" /> </g> <circle class="calendar-3" cx="232.87" cy="179.38" r="41.25" /> <g class="calendar-10"> <rect class="calendar-7" x="231.93" y="178.44" width="56.25" height="50.63" /> </g> <rect class="calendar-11" x="206.62" y="20" width="52.5" height="185.63" rx="26.25" /> <rect class="calendar-11" x="373.5" y="20" width="52.5" height="185.63" rx="26.25" /> <rect class="calendar-11" x="538.5" y="20" width="52.5" height="185.63" rx="26.25" /> <rect class="calendar-11" x="703.5" y="20" width="52.5" height="185.63" rx="26.25" /> </svg>';
const data = document.getElementById("campaign-data").textContent;

let campaign = JSON.parse(data);
const parser = new DOMParser();

let campaignAmount = document.getElementById("campaign-amount");
function updateCampaignProgress() {
    campaignAmount.textContent = `${campaign.current_amount} /`;
    if (campaign.is_target_hidden) {
        campaignAmount.textContent += ` ?`;
    } else {
        campaignAmount.textContent += ` ${campaign.target_amount}`;
        if (campaign.type === "donation") {
            campaignAmount.textContent += ` â‚¬`;
        }
    }
    let previousGoal = 0;
    let lockGoal = false;
    for (let i = 0; i < campaign.goals.length; i++) {
        let goal = campaign.goals[i];
        let goalDiv = document.getElementById("goal-progress-" + goal.id);
        let progress = Math.min(
            100,
            Math.max(
                0,
                ((campaign.current_amount - previousGoal) /
                    (goal.goal - previousGoal)) *
                100,
            ),
        );
        previousGoal = goal.goal;
        let progressBar = goalDiv.querySelector(".progress-bar-fill");

        progressBar.style.width = progress + "%";
        if (progress >= 100) {
            validateGoal(goalDiv);
        }
        if (campaign.current_amount < goal.goal && !lockGoal) {
            lockGoal = true;
            displayNextGoal(goal);
        }
        if (
            campaign.current_amount >= campaign.goals[campaign.goals.length - 1].goal
        ) {
            displayNextGoal({ title: "FINI !!!" });
        }
    }
}

function initCampaign() {
    initTitle();
    addGoalMarkers();
    updateCampaignProgress();
}

function initTitle() {
    let titleDiv = document.getElementById("campaign-title");
    let titleType = campaign.type;
    if (titleDiv) {
        if (titleType === "donation") {
            titleDiv.textContent = "Tips Goal";
        } else if (titleType === "sub") {
            titleDiv.textContent = "Sub Goal";
        } else {
            titleDiv.textContent = "Goal";
        }
    }
}

function displayNextGoal(goal) {
    let nextGoalDiv = document.getElementById("next-goal-amount");
    if (nextGoalDiv) {
        nextGoalDiv.textContent = goal.title;
    }
}
function addGoalMarkers() {
    for (let i = 0; i < campaign.goals.length; i++) {
        let goal = campaign.goals[i];

        let goalContainer = document.createElement("div");
        goalContainer.className = "goal-container";

        let goalDiv = document.createElement("div");
        goalDiv.className = "goal-marker";
        goalDiv.setAttribute("data-goal-id", goal.id);
        goalContainer.appendChild(goalDiv);

        let goalIcon = document.createElement("div");
        goalIcon.className = "goal-icon";
        goalIcon.innerHTML = giftSVG;
        goalDiv.appendChild(goalIcon);

        let linkedBar = document.getElementById("goal-progress-" + goal.id);
        linkedBar.appendChild(goalContainer);
    }
}

function validateGoal(goalDiv) {
    let markerDiv = goalDiv.querySelector(".goal-marker");
    if (markerDiv) {
        if (!markerDiv.classList.contains("validate-marker")) {
            markerDiv.classList.add("validate-marker");
            addValidateIndicator(markerDiv);
        }
    }
}

function addValidateIndicator(goalDiv) {
    let goalIcon = document.createElement("div");
    goalIcon.className = "goal-icon";
    let oldIcon = goalDiv.querySelector(".goal-icon");
    if (oldIcon) {
        oldIcon.classList.add("vanishing");
    }
    let goalIconType = campaign.goals.find(
        (g) => g.id == goalDiv.getAttribute("data-goal-id"),
    ).icon;
    if (goalIconType === "calendar") {
        goalIcon.innerHTML = calendarSVG;
    } else {
        goalIcon.innerHTML = giftValidateSVG;
    }

    goalDiv.insertAdjacentElement("afterbegin", goalIcon);

    let goalId = goalDiv.getAttribute("data-goal-id");
    let indicator = campaign.goals.find((g) => g.id == goalId).indicator;
    let indicatorDiv = document.createElement("div");
    indicatorDiv.className = "indicator-container";
    let pTag = document.createElement("p");
    pTag.textContent = indicator;
    pTag.className = "goal-indicator";
    indicatorDiv.appendChild(pTag);
    goalDiv.insertAdjacentElement("afterend", indicatorDiv);
}

// Websocket
let ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
let ws_url =
    ws_scheme +
    "://" +
    window.location.host +
    "/ws/campaigns/" +
    campaign.id +
    "/";

function connect() {
    var ws = new WebSocket(ws_url);

    ws.onmessage = function(event) {
        var data_ws = JSON.parse(event.data);

        if (data_ws.type == "progress_update") {
            campaign.current_amount = data_ws.current_amount;
            updateCampaignProgress();
        } else if (data_ws.type == "campaign_update") {
            campaign = data_ws.campaign;
            initCampaign();
        }
    };

    ws.onclose = function(event) {
        console.log("Connection closed");
        connect();
    };

    ws.onerror = function(event) {
        console.log("Error");
        ws.close();
    };
}

connect();
initCampaign();
